<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>ds9 scripting</title>
        <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
        <!-- Font Awesome icons (free version)-->
        <script src="https://use.fontawesome.com/releases/v6.1.0/js/all.js" crossorigin="anonymous"></script>
        <!-- Google fonts-->
        <link href="https://fonts.googleapis.com/css?family=Varela+Round" rel="stylesheet" />
        <link href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i" rel="stylesheet" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.3.1/styles/default.min.css">
        <!-- Core theme CSS (includes Bootstrap)-->
        <link href="css/styles.css" rel="stylesheet" />
        <style>
        .code-cell {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1.25rem;
            margin: 1.5rem 0;
            overflow-x: auto;
        }
        
        .code-cell pre {
            margin: 0;
            background: none;
            border: none;
            padding: 0;
        }
        
        .code-cell code {
            background: none;
            color: inherit;
            font-family: 'SFMono-Regular', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace;
            font-size: 0.875rem;
            line-height: 1.6;
        }
        
        .input-prompt {
            color: #0d6efd;
            font-weight: bold;
            margin-right: 0.5rem;
            user-select: none;
        }
        
        .content-section {
            padding: 2rem 1rem;
        }
        
        @media (min-width: 768px) {
            .content-section {
                padding: 3rem 2rem;
            }
        }
        
        @media (min-width: 992px) {
            .content-section {
                padding: 4rem 3rem;
            }
        }
        
        .article-image {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        </style>
    </head>


    <body id="page-top">
        <!-- Navigation-->
        <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
            <div class="container px-4 px-lg-5">
                <a class="navbar-brand" href="index.html">home</a>
                <button class="navbar-toggler navbar-toggler-right" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                    Menu
                    <i class="fas fa-bars"></i>
                </button>
                <div class="collapse navbar-collapse" id="navbarResponsive">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item"><a class="nav-link" href="index.html#about">About</a></li>
                        <li class="nav-item"><a class="nav-link" href="index.html#projects">Posts</a></li>
                        <li class="nav-item"><a class="nav-link" href="index.html#signup">Contact</a></li>
                    </ul>
                </div>
            </div>
        </nav>


        <header class="blog-post-ds9-subprocesses">
            <div class="container px-4 px-lg-5 d-flex h-100 align-items-center justify-content-center">
                <div class="d-flex justify-content-center">
                    <div class="text-center">
                        <h1 class="mx-auto my-0 text-white">
                        </h1>
                        <h6 class="text-white-50 mx-auto mt-2 mb-5"> 

                        </h6>
                        
                        <a class="btn btn-primary" href="#fullpost">read the article</a>

                        
                    </div>
                </div>
            </div>
        </header>
            <section class="projects-section bg-light content-section" id="fullpost">
                <div class="container px-2 px-md-4 px-lg-5">
                    <h1 class="text-danger mb-4">DS9 scripting using Python subprocesses</h1>
                    
                    <div class="row">
                        <div class="col-lg-10 mx-auto">
                            <p class="lead">
                                During my master's thesis (<strong>Gupta et. al. 2024, submitted to A&A</strong>) work at the European Southern Observatory (ESO), I worked on searching for stellar clusters in the Milky Way using whole GLIMPSE data, so, naturally I required three color images of a lot of objects and from different infrared surveys (2MASS, <em>WISE</em>, <em>Spitzer</em>).
                            </p>
                            
                            <p>
                                To do this one by one was one heck of a problem, especially when you have 100s of sources. A good solution is go to IRSA website and download the images one by one but for how long? An automated or at least semi-automated process is indeed required.
                            </p>
                            
                            <p>
                                I found a new way to fetch the images by using a new python module called <a href="https://github.com/esdc-esac-esa-int/pyesasky" class="text-decoration-none">pyESASky</a> and this was introduced to me by Marcos Lopez (ESA/ESAC, Madrid) in the SciOPs conference on AI, 2022 held at European Southern Observatory HQ in Garching. But the website was still a bit experimental and there is problem with minimum size of images which could be fetched and it certainly doesn't match my requirements.
                            </p>
                            
                            <p>
                                So, I decided to do this the traditional way using IRSA servers to fetch fits files and use DS9 to make three color images. Although <code>pyds9</code> exists, I could not find an operational version. So, I decided to combine python subprocesses and DS9 to automatically generate three color images.
                            </p>
                            
                            <div class="alert alert-info">
                                <p class="mb-2">
                                    <strong>The idea:</strong> Download all the fits files from IRSA by passing a list of coordinates and saving it. I'd suggest not to fetch more than 100 images at once as the website is a bit slow. After you have a zip file downloaded to a folder, just unzip it and you'll see folders with named ra+dec (ex. 293.711682+20.625794 or 293.711682-20.625794) and with raw fits images with systematic naming.
                                </p>
                            </div>
                            
                            <div class="alert alert-secondary">
                                <p class="mb-0">
                                    <strong>Interesting note:</strong> DS9 is named after Star Trek series Deep Space 9.
                                </p>
                            </div>

                            <h3 class="mt-5 mb-3">Load packages:</h3>
                            <div class="code-cell">
                                <span class="input-prompt">In [1]:</span>
                                <pre><code class="python">import pandas as pd
from decimal import Decimal
import subprocess
import time
import matplotlib.pyplot as plt
from astropy.coordinates import SkyCoord
from astropy import units as u
from PIL import Image</code></pre>
                            </div>
                            
                            <div class="alert alert-warning">
                                <p class="mb-0">
                                    <strong>pip installation:</strong> <code>pip install pandas matplotlib astropy pillow</code><br>
                                    Install <code>matplotlib</code> only for visualization using Python.
                                </p>
                            </div>

                            <h3 class="mt-5 mb-3">Main script:</h3>
                            <div class="code-cell">
                                <span class="input-prompt">In [2]:</span>
                                <pre><code class="python"># Read coordinates from CSV file
aprg = pd.read_csv('C:/Users/akash/Downloads/APRG_All-part1/coords.csv')

for i in range(aprg.shape[0]):
    # Format coordinates for filename matching
    radec = f"{aprg['ra'][i]:f}{aprg['dec'][i]:+f}"
    print(f"Processing {i+1}/{aprg.shape[0]}: {radec}")
    
    # GLIMPSE (Spitzer) RGB composite
    ds9_glimpse_cmd = [
        'C:\\SAOImageDS9\\ds9.exe',
        '-rgb',
        '-fits', f"C:/Users/akash/Downloads/APRG_All-part1/{radec}/fc_{radec}_spitzer_seipirac4(2.4)_reproj.fits",
        '-scale', 'ZScale',
        '-rgb', 'channel', 'green',
        '-fits', f"C:/Users/akash/Downloads/APRG_All-part1/{radec}/fc_{radec}_spitzer_seipirac2(2.4)_reproj.fits",
        '-scale', 'ZScale',
        '-rgb', 'channel', 'blue',
        '-fits', f"C:/Users/akash/Downloads/APRG_All-part1/{radec}/fc_{radec}_spitzer_seipirac1(2.4)_reproj.fits",
        '-scale', 'ZScale',
        '-zoom', 'to', 'fit',
        '-colorbar', 'no',
        '-export', f"C:/Users/akash/Desktop/MIROCLS/Three_Color_Images/GLIMPSE/{radec}_glimpse.jpeg", '100'
    ]
    
    ds9 = subprocess.Popen(ds9_glimpse_cmd)
    time.sleep(5.0)
    ds9.terminate()
    
    # WISE RGB composite
    ds9_wise_cmd = [
        'C:\\SAOImageDS9\\ds9.exe',
        '-rgb',
        '-fits', f"C:/Users/akash/Downloads/APRG_All-part1/{radec}/fc_{radec}_wise_4_reproj.fits",
        '-scale', 'ZScale',
        '-rgb', 'channel', 'green',
        '-fits', f"C:/Users/akash/Downloads/APRG_All-part1/{radec}/fc_{radec}_wise_2_reproj.fits",
        '-scale', 'ZScale',
        '-rgb', 'channel', 'blue',
        '-fits', f"C:/Users/akash/Downloads/APRG_All-part1/{radec}/fc_{radec}_wise_1_reproj.fits",
        '-scale', 'ZScale',
        '-zoom', 'to', 'fit',
        '-colorbar', 'no',
        '-export', f"C:/Users/akash/Desktop/MIROCLS/Three_Color_Images/WISE/{radec}_wise.jpeg", '100'
    ]
    
    ds9 = subprocess.Popen(ds9_wise_cmd)
    time.sleep(5.0)
    ds9.terminate()
    
    # 2MASS RGB composite
    ds9_2mass_cmd = [
        'C:\\SAOImageDS9\\ds9.exe',
        '-rgb',
        '-fits', f"C:/Users/akash/Downloads/APRG_All-part1/{radec}/fc_{radec}_2mass_k_reproj.fits",
        '-scale', 'ZScale',
        '-rgb', 'channel', 'green',
        '-fits', f"C:/Users/akash/Downloads/APRG_All-part1/{radec}/fc_{radec}_2mass_h_reproj.fits",
        '-scale', 'ZScale',
        '-rgb', 'channel', 'blue',
        '-fits', f"C:/Users/akash/Downloads/APRG_All-part1/{radec}/fc_{radec}_2mass_j_reproj.fits",
        '-scale', 'ZScale',
        '-zoom', 'to', 'fit',
        '-colorbar', 'no',
        '-export', f"C:/Users/akash/Desktop/MIROCLS/Three_Color_Images/2MASS/{radec}_2mass.jpeg", '100'
    ]
    
    ds9 = subprocess.Popen(ds9_2mass_cmd)
    time.sleep(5.0)
    ds9.terminate()</code></pre>
                            </div>

                            <div class="alert alert-info mt-4">
                                <p class="mb-0">
                                    I have created three instances of DS9 scripting for <em>Spitzer</em>, <em>WISE</em> and 2MASS respectively. All of them use the same chain of commands except for the filenames. The subprocess works just like opening DS9, selecting RGB mode, loading FITS images, setting scales and colors, then exporting the final composite image.
                                </p>
                            </div>

                            <h3 class="mt-5 mb-3">Visualization (optional):</h3>
                            <p class="text-muted">Adjust according to your needs. This creates a grid layout of all processed images.</p>
                            
                            <div class="code-cell">
                                <span class="input-prompt">In [3]:</span>
                                <pre><code class="python"># Create a grid plot of GLIMPSE images
fig, ax = plt.subplots(4, 5, figsize=(25, 20))

for i in range(min(aprg.shape[0], 20)):  # Limit to 20 images for 4x5 grid
    size = 150 / 3600  # Size in degrees
    ra, dec = aprg['ra'][i], aprg['dec'][i]
    ra, dec = round(Decimal(ra), 6), round(Decimal(dec), 6)
    radec = f"{aprg['ra'][i]:f}{aprg['dec'][i]:+f}"
    
    # Convert to galactic coordinates
    gc = SkyCoord(ra=ra * u.degree, dec=dec * u.degree, frame='fk5', unit='deg')
    l, b = gc.galactic.l.value, gc.galactic.b.value

    # Load and display image
    img_path = f'C:/Users/akash/Desktop/MIROCLS/Three_Color_Images/GLIMPSE/{radec}_glimpse.jpeg'
    try:
        img = Image.open(img_path)
        row, col = divmod(i, 5)
        ax[row, col].imshow(img, extent=[
            l - size * 0.5, l + size * 0.5, 
            b - size * 0.5, b + size * 0.5
        ])
        ax[row, col].set_title(f'APRG {i+1} ({l:.4f}, {b:.4f})', fontsize=15)
        ax[row, col].set_xlabel('Galactic Longitude')
        ax[row, col].set_ylabel('Galactic Latitude')
    except FileNotFoundError:
        print(f"Image not found: {img_path}")

plt.tight_layout()
plt.savefig("C:/Users/akash/Desktop/MIROCLS/Three_Color_Images/GLIMPSE_APRG.pdf", dpi=300)
plt.show()</code></pre>
                            </div>

                            <h3 class="mt-5 mb-3">Stacked <em>Spitzer</em> Images from the code:</h3>
                            <p class="text-muted">All coordinates in Galactic Coordinate System.</p>
                            <div class="text-center">
                                <img src="assets/img/GLIMPSE_APRG_page-0001.jpg" 
                                     alt="Stacked Spitzer Images showing various astronomical objects" 
                                     class="article-image" />
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            

</body>
</html>
